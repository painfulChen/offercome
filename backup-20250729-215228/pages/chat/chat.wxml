<!--pages/chat/chat.wxml-->
<view class="container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <view class="header">
    <view class="conversation-selector" bindtap="toggleConversationSelector">
      <text class="current-title">{{conversations.find(c => c.id === conversationId)?.title || 'æ–°å¯¹è¯'}}</text>
      <image class="dropdown-icon" src="/images/icon-dropdown.png" mode="aspectFit"></image>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="onNewConversation">
        <image class="action-icon" src="/images/icon-new-chat.png" mode="aspectFit"></image>
      </view>
    </view>
  </view>
  
  <!-- ä¼šè¯é€‰æ‹©å™¨å¼¹å‡ºå±‚ -->
  <view class="conversation-dropdown {{showConversationSelector ? 'show' : ''}}" wx:if="{{showConversationSelector}}">
    <view class="dropdown-mask" bindtap="toggleConversationSelector"></view>
    <view class="dropdown-content">
      <view class="dropdown-header">
        <text>é€‰æ‹©ä¼šè¯</text>
        <view class="close-btn" bindtap="toggleConversationSelector">
          <image src="/images/icon-close.png" mode="aspectFit"></image>
        </view>
      </view>
      <scroll-view scroll-y class="conversation-list">
        <view 
          class="conversation-item {{item.id === conversationId ? 'active' : ''}}" 
          wx:for="{{conversations}}" 
          wx:key="id"
          data-id="{{item.id}}"
          bindtap="selectConversation"
        >
          <view class="conversation-info">
            <text class="conversation-title">{{item.title}}</text>
            <text class="conversation-time">{{item.updatedAt}}</text>
          </view>
          <view class="unread-badge" wx:if="{{item.unreadCount > 0}}">
            <text>{{item.unreadCount}}</text>
          </view>
        </view>
        <view class="new-conversation-btn" bindtap="onNewConversation">
          <image src="/images/icon-add.png" mode="aspectFit"></image>
          <text>æ–°å»ºä¼šè¯</text>
        </view>
      </scroll-view>
    </view>
  </view>
  
  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    scroll-y 
    class="message-list" 
    id="message-list" 
    style="height: {{scrollHeight}}px;"
    enable-back-to-top
    scroll-anchoring
  >
    <!-- åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨ -->
    <view class="loading-more" wx:if="{{isLoadingHistory}}">
      <view class="loading-spinner"></view>
      <text>åŠ è½½æ›´å¤šæ¶ˆæ¯...</text>
    </view>
    
    <!-- æ¶ˆæ¯å†…å®¹ -->
    <block wx:for="{{messages}}" wx:key="id">
      <!-- æ—¶é—´åˆ†å‰²çº¿ -->
      <view class="time-divider" wx:if="{{index === 0 || messages[index].timestamp.split('T')[0] !== messages[index-1].timestamp.split('T')[0]}}">
        <text>{{item.timestamp.split('T')[0]}}</text>
      </view>
      
      <!-- æ¶ˆæ¯æ°”æ³¡ -->
      <view class="message-item {{item.role === 'user' ? 'user' : 'assistant'}}">
        <!-- ç”¨æˆ·å¤´åƒ -->
        <view class="avatar" wx:if="{{item.role === 'user'}}">
          <open-data type="userAvatarUrl"></open-data>
        </view>
        
        <!-- AIå¤´åƒ -->
        <image class="avatar" wx:else src="/images/icon-ai-avatar.png" mode="aspectFit"></image>
        
        <!-- æ¶ˆæ¯å†…å®¹ -->
        <view class="message-content {{item.pending ? 'pending' : ''}}">
          <!-- æ–‡æœ¬æ¶ˆæ¯ -->
          <view class="text-content" wx:if="{{!item.imageUrl && !item.voiceUrl}}">
            <text selectable>{{item.content}}</text>
          </view>
          
          <!-- å›¾ç‰‡æ¶ˆæ¯ -->
          <view class="image-content" wx:if="{{item.imageUrl}}">
            <image 
              src="{{item.imageUrl}}" 
              mode="widthFix" 
              bindtap="previewImage" 
              data-url="{{item.imageUrl}}"
            ></image>
            <text wx:if="{{item.content !== '[å›¾ç‰‡]'}}">{{item.content}}</text>
          </view>
          
          <!-- è¯­éŸ³æ¶ˆæ¯ -->
          <view class="voice-content" wx:if="{{item.voiceUrl}}" bindtap="playVoice" data-url="{{item.voiceUrl}}">
            <image class="voice-icon" src="/images/icon-voice-play.png" mode="aspectFit"></image>
            <text class="voice-duration">{{item.voiceDuration || '0'}}â€³</text>
            <text wx:if="{{item.content !== '[è¯­éŸ³æ¶ˆæ¯]'}}">{{item.content}}</text>
          </view>
          
          <!-- æ¶ˆæ¯æ“ä½œæŒ‰é’® -->
          <view class="message-actions">
            <view class="action-btn" bindtap="copyMessageContent" data-index="{{index}}">
              <image src="/images/icon-copy.png" mode="aspectFit"></image>
            </view>
            <view class="action-btn" wx:if="{{item.role === 'assistant' && index === messages.length - 1}}" bindtap="regenerateAnswer">
              <image src="/images/icon-refresh.png" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- AIæ€è€ƒä¸­çŠ¶æ€ -->
    <view class="thinking-indicator" wx:if="{{isAIThinking}}">
      <view class="thinking-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
      <text>AIæ€è€ƒä¸­...</text>
    </view>
  </scroll-view>
  
  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-area" style="padding-bottom: {{safeAreaBottom}}px;">
    <!-- è¯­éŸ³è¾“å…¥æ¨¡å¼ -->
    <view class="voice-input-mode" wx:if="{{showVoiceButton && !isRecording}}">
      <view class="mode-switch" bindtap="toggleInputMode">
        <image src="/images/icon-keyboard.png" mode="aspectFit"></image>
      </view>
      <view class="voice-button" bindtouchstart="startRecording" bindtouchend="stopRecording">
        <text>æŒ‰ä½è¯´è¯</text>
      </view>
    </view>
    
    <!-- å½•éŸ³ä¸­çŠ¶æ€ -->
    <view class="recording-status" wx:if="{{isRecording}}">
      <view class="recording-tip {{showCancelRecordTip ? 'cancel' : ''}}">
        <view class="recording-wave"></view>
        <text wx:if="{{!showCancelRecordTip}}">{{recordingTime}}â€³ æ¾å¼€å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ</text>
        <text wx:else>æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€</text>
      </view>
    </view>
    
    <!-- æ–‡æœ¬è¾“å…¥æ¨¡å¼ -->
    <view class="text-input-mode" wx:if="{{!showVoiceButton || isRecording}}">
      <view class="mode-switch" bindtap="toggleInputMode">
        <image src="/images/icon-voice.png" mode="aspectFit"></image>
      </view>
      <view class="input-wrapper">
        <textarea 
          class="input" 
          placeholder="è¾“å…¥æ¶ˆæ¯..." 
          value="{{inputContent}}" 
          bindinput="onInputChange" 
          bindfocus="onInputFocus"
          bindblur="onInputBlur"
          auto-height
          cursor-spacing="10"
          show-confirm-bar="{{false}}"
          adjust-position="{{false}}"
          hold-keyboard="{{true}}"
          disabled="{{isSending}}"
        ></textarea>
      </view>
      <view class="emoji-btn" bindtap="toggleEmojiPicker">
        <image src="/images/icon-emoji.png" mode="aspectFit"></image>
      </view>
      <view class="more-btn" bindtap="toggleMorePanel">
        <image src="/images/icon-more.png" mode="aspectFit"></image>
      </view>
      <view class="send-btn {{showSendButton ? 'show' : ''}}" bindtap="sendMessage">
        <image src="/images/icon-send.png" mode="aspectFit"></image>
      </view>
    </view>
    
    <!-- è¡¨æƒ…é€‰æ‹©å™¨ -->
    <view class="emoji-picker" wx:if="{{showEmojiPicker}}" style="bottom: {{keyboardHeight + safeAreaBottom}}px;">
      <scroll-view scroll-y class="emoji-list">
        <view class="emoji-grid">
          <view class="emoji-item" wx:for="{{['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ¤¯','ğŸ˜³','ğŸ¥µ','ğŸ¥¶','ğŸ˜±','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜“','ğŸ¤—','ğŸ¤”','ğŸ¤­','ğŸ¤«','ğŸ¤¥','ğŸ˜¶','ğŸ˜','ğŸ˜‘','ğŸ˜¬','ğŸ™„','ğŸ˜¯','ğŸ˜¦','ğŸ˜§','ğŸ˜®','ğŸ˜²','ğŸ¥±','ğŸ˜´','ğŸ¤¤','ğŸ˜ª','ğŸ˜µ','ğŸ¤','ğŸ¥´','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤‘','ğŸ¤ ','ğŸ˜ˆ','ğŸ‘¿','ğŸ‘¹','ğŸ‘º','ğŸ¤¡','ğŸ’©','ğŸ‘»','ğŸ’€','â˜ ï¸','ğŸ‘½','ğŸ‘¾','ğŸ¤–','ğŸƒ','ğŸ˜º','ğŸ˜¸','ğŸ˜¹','ğŸ˜»','ğŸ˜¼','ğŸ˜½','ğŸ™€','ğŸ˜¿','ğŸ˜¾']}}" wx:key="*this" bindtap="selectEmoji" data-emoji="{{item}}">
            <text>{{item}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
    
    <!-- æ›´å¤šåŠŸèƒ½é¢æ¿ -->
    <view class="more-panel" wx:if="{{showMorePanel}}" style="bottom: {{keyboardHeight + safeAreaBottom}}px;">
      <view class="panel-grid">
        <view class="panel-item" bindtap="uploadImage">
          <view class="panel-icon">
            <image src="/images/icon-image.png" mode="aspectFit"></image>
          </view>
          <text>å›¾ç‰‡</text>
        </view>
      </view>
    </view>
  </view>
</view>