# 开发原则必读文档

> **重要**: 所有开发人员必须阅读并遵循本文档中的原则。这些原则是项目成功的基础。

## 📋 文档概览

- [核心开发原则](#核心开发原则)
- [路由管理原则](#路由管理原则)
- [部署原则](#部署原则)
- [代码质量原则](#代码质量原则)
- [安全原则](#安全原则)
- [监控原则](#监控原则)
- [团队协作原则](#团队协作原则)

---

## 🎯 核心开发原则

### 1. 单一配置源原则
> **原则**: 所有配置必须有一个权威的配置源，避免配置分散和冲突。

**实践要求**:
- ✅ 路由配置集中在 `server/routes.js`
- ✅ 部署配置集中在 `cloudbaserc.json`
- ✅ 环境变量集中在 `.env` 文件
- ❌ 禁止在多个地方重复配置同一项内容

**违反后果**: 配置冲突、部署失败、功能异常

### 2. 声明式优于命令式
> **原则**: 优先使用声明式配置，而不是命令式代码。

**实践要求**:
- ✅ 路由在配置文件中声明
- ✅ 依赖在 `package.json` 中声明
- ✅ 测试用例在配置中声明
- ❌ 避免硬编码和魔法数字

**违反后果**: 代码难以维护、配置不透明

### 3. 自动化优先原则
> **原则**: 所有重复性工作都应该自动化。

**实践要求**:
- ✅ 使用 `./deploy.sh` 一键部署
- ✅ 使用 `npm test` 自动测试
- ✅ 使用 CI/CD 自动构建和部署
- ❌ 禁止手动重复操作

**违反后果**: 效率低下、人为错误

---

## 🛣️ 路由管理原则

### 1. 集中路由表原则
> **原则**: 所有路由必须在 `server/routes.js` 中声明。

**实践要求**:
```javascript
// ✅ 正确做法
{
  path: '/new-feature',
  method: 'POST',
  handler: 'newFeatureHandler',
  description: '新功能接口',
  auth: true,
  rateLimit: 10
}

// ❌ 错误做法 - 直接在代码中定义路由
app.post('/new-feature', handler);
```

**检查清单**:
- [ ] 路由是否在 `routes.js` 中声明？
- [ ] 是否提供了完整的描述？
- [ ] 是否正确设置了认证和速率限制？

### 2. 前缀统一原则
> **原则**: 所有API路由必须使用统一的前缀 `/api-v2`。

**实践要求**:
- ✅ 使用 `API_PREFIX` 常量
- ✅ 自动注入前缀，不手动拼接
- ❌ 禁止硬编码路径前缀

### 3. 路由验证原则
> **原则**: 所有路由必须通过自动验证。

**实践要求**:
- ✅ 启动期自检所有路由
- ✅ 单元测试覆盖所有路由
- ✅ 冒烟测试验证关键路由

---

## 🚀 部署原则

### 1. 强制部署原则
> **原则**: 部署时必须使用 `--force` 参数，防止旧版本复活。

**实践要求**:
```bash
# ✅ 正确做法
tcb framework:deploy -e $TCB_ENV_ID --force

# ❌ 错误做法
tcb framework:deploy -e $TCB_ENV_ID
```

### 2. 测试先行原则
> **原则**: 部署前必须通过所有测试。

**实践要求**:
- ✅ 单元测试覆盖率 ≥ 90%
- ✅ 路由覆盖测试通过
- ✅ 冒烟测试通过
- ❌ 禁止跳过测试直接部署

### 3. 配置即代码原则
> **原则**: 所有配置都应该版本控制，避免环境差异。

**实践要求**:
- ✅ `cloudbaserc.json` 版本控制
- ✅ 环境变量模板化
- ✅ 部署脚本版本控制

---

## 📊 代码质量原则

### 1. 测试驱动原则
> **原则**: 新功能必须先写测试，再写实现。

**实践要求**:
```javascript
// ✅ 正确做法 - 先写测试
test('新功能应该正常工作', () => {
  // 测试逻辑
});

// 再写实现
function newFeature() {
  // 实现逻辑
}
```

### 2. 文档即代码原则
> **原则**: 文档和代码同步更新，文档也是代码的一部分。

**实践要求**:
- ✅ API文档自动生成
- ✅ 路由文档自动更新
- ✅ 部署报告自动生成

### 3. 错误处理原则
> **原则**: 所有可能的错误都必须被处理。

**实践要求**:
```javascript
// ✅ 正确做法
try {
  const result = await riskyOperation();
  return result;
} catch (error) {
  console.error('操作失败:', error);
  throw new Error('用户友好的错误信息');
}

// ❌ 错误做法
const result = await riskyOperation(); // 可能抛出未处理的错误
```

---

## 🔒 安全原则

### 1. 最小权限原则
> **原则**: 只授予必要的最小权限。

**实践要求**:
- ✅ 路由级别的认证控制
- ✅ 速率限制防止滥用
- ✅ 输入验证防止注入

### 2. 密钥管理原则
> **原则**: 敏感信息必须安全存储，不得硬编码。

**实践要求**:
- ✅ 使用环境变量存储密钥
- ✅ 使用 `.env` 文件管理本地环境
- ❌ 禁止在代码中硬编码密钥

### 3. 数据验证原则
> **原则**: 所有外部输入都必须验证。

**实践要求**:
```javascript
// ✅ 正确做法
const validateInput = (data) => {
  if (!data || typeof data !== 'object') {
    throw new Error('无效的输入数据');
  }
  // 更多验证...
};

// ❌ 错误做法
function processData(data) {
  // 直接使用未验证的数据
  return data.someProperty;
}
```

---

## 📈 监控原则

### 1. 可观测性原则
> **原则**: 系统必须提供足够的观测能力。

**实践要求**:
- ✅ 路由缺失监控
- ✅ 性能指标监控
- ✅ 错误率监控
- ✅ 部署状态监控

### 2. 告警及时原则
> **原则**: 问题发生时必须及时告警。

**实践要求**:
- ✅ 路由404超过阈值立即告警
- ✅ 部署失败立即通知
- ✅ 性能下降及时预警

### 3. 日志规范原则
> **原则**: 日志必须结构化、可搜索。

**实践要求**:
```javascript
// ✅ 正确做法
console.log(JSON.stringify({
  timestamp: new Date().toISOString(),
  level: 'INFO',
  message: '用户登录成功',
  userId: '12345',
  ip: '192.168.1.1'
}));

// ❌ 错误做法
console.log('用户登录成功'); // 信息不完整
```

---

## 👥 团队协作原则

### 1. 代码审查原则
> **原则**: 所有代码变更都必须经过审查。

**实践要求**:
- ✅ 提交前自测
- ✅ 代码审查通过
- ✅ 测试覆盖率检查
- ❌ 禁止直接合并到主分支

### 2. 文档优先原则
> **原则**: 新功能必须先有文档，再有代码。

**实践要求**:
- ✅ API设计文档
- ✅ 部署指南更新
- ✅ 用户手册更新

### 3. 版本控制原则
> **原则**: 所有变更都必须版本控制。

**实践要求**:
- ✅ 有意义的提交信息
- ✅ 功能分支命名规范
- ✅ 版本标签管理

---

## 🚨 违反原则的处理

### 严重违反
以下行为被视为严重违反开发原则：

1. **跳过测试直接部署**
   - 处理: 立即回滚，暂停部署权限
   - 恢复: 通过完整测试后恢复权限

2. **硬编码敏感信息**
   - 处理: 立即移除，更换密钥
   - 恢复: 完成安全审计后恢复

3. **绕过路由管理**
   - 处理: 立即修复，重新部署
   - 恢复: 通过路由验证后恢复

### 轻微违反
以下行为被视为轻微违反：

1. **文档更新不及时**
   - 处理: 限期补全文档
   - 恢复: 文档更新完成后恢复

2. **测试覆盖率不足**
   - 处理: 限期补充测试
   - 恢复: 覆盖率达标后恢复

---

## 📚 必读文档清单

所有开发人员必须阅读以下文档：

### 核心文档
1. **本文档** - 开发原则总览
2. `ROUTE_OPTIMIZATION_GUIDE.md` - 路由优化指南
3. `API_ROUTES.md` - API路由文档
4. `DEPLOYMENT_GUIDE.md` - 部署指南

### 工具文档
5. `quick-verify.js` - 快速验证脚本
6. `deploy.sh` - 一键部署脚本
7. `server/jest.config.js` - 测试配置

### 配置文件
8. `cloudbaserc.json` - 部署配置
9. `server/routes.js` - 路由配置
10. `server/package.json` - 项目配置

---

## ✅ 检查清单

### 新功能开发前
- [ ] 阅读相关文档
- [ ] 理解业务需求
- [ ] 设计API接口
- [ ] 编写测试用例

### 代码提交前
- [ ] 运行所有测试
- [ ] 检查代码规范
- [ ] 更新相关文档
- [ ] 验证路由配置

### 部署前
- [ ] 通过所有测试
- [ ] 检查环境变量
- [ ] 验证部署配置
- [ ] 准备回滚方案

### 部署后
- [ ] 验证功能正常
- [ ] 检查监控指标
- [ ] 更新部署报告
- [ ] 通知相关人员

---

## 🎯 总结

这些开发原则是项目成功的基石。遵循这些原则可以：

1. **提高代码质量** - 通过测试驱动和代码审查
2. **减少部署风险** - 通过自动化部署和强制测试
3. **提升开发效率** - 通过工具化和标准化
4. **保障系统安全** - 通过安全原则和监控告警
5. **促进团队协作** - 通过文档优先和版本控制

**记住**: 这些原则不是限制，而是帮助我们构建更好系统的工具。当遇到特殊情况时，可以与团队讨论，但必须有充分的理由和替代方案。

---

> **最后提醒**: 本文档会定期更新，请确保阅读最新版本。如有疑问，请及时与团队讨论。 