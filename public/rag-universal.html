<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG通用管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="components/rag-ui.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info span {
            color: #2c3e50;
            font-weight: 600;
        }

        .logout-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .section {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 用户信息 -->
        <div class="user-info">
            <span id="username">管理员</span>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> 退出
            </button>
        </div>

        <!-- 页面标题 -->
        <div class="header">
            <h1><i class="fas fa-brain"></i> RAG通用管理系统</h1>
            <p>智能文档管理与检索系统</p>
        </div>

        <!-- 主要内容区域 -->
        <div class="content-grid">
            <!-- 统计概览 -->
            <section id="section-overview" class="section">
                <h2><i class="fas fa-chart-bar"></i> 系统概览</h2>
                <div class="stats-grid" id="overview-stats">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </section>

            <!-- 文档上传 -->
            <section id="section-upload" class="section">
                <h2><i class="fas fa-cloud-upload-alt"></i> 文档上传</h2>
                <div id="upload-container"></div>
            </section>

            <!-- 智能搜索 -->
            <section id="section-search" class="section">
                <h2><i class="fas fa-search"></i> 智能搜索</h2>
                <div id="search-container"></div>
            </section>

            <!-- 文档管理 -->
            <section id="section-documents" class="section">
                <h2><i class="fas fa-folder-open"></i> 文档管理</h2>
                <div id="documents-container"></div>
            </section>

            <!-- 系统状态 -->
            <section id="section-status" class="section">
                <h2><i class="fas fa-cogs"></i> 系统状态</h2>
                <div id="status-container"></div>
            </section>
        </div>
    </div>

    <script>
        // 全局配置
        const RAG_CONFIG = {
            apiBase: '/api/rag',
            token: localStorage.getItem('rag_token') || '',
            theme: 'default'
        };

        // 初始化RAG UI
        let ragUI;
        let tocId;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeRAGSystem();
        });

        // 初始化RAG系统
        async function initializeRAGSystem() {
            try {
                // 检查登录状态
                if (!RAG_CONFIG.token) {
                    window.location.href = '/public/login.html';
                    return;
                }

                // 初始化RAG UI
                ragUI = new RAGUI(RAG_CONFIG);

                // 创建TOC
                const sections = [
                    { id: 'section-overview', title: '系统概览' },
                    { id: 'section-upload', title: '文档上传' },
                    { id: 'section-search', title: '智能搜索' },
                    { id: 'section-documents', title: '文档管理' },
                    { id: 'section-status', title: '系统状态' }
                ];
                tocId = ragUI.createTOC(document.body, sections);

                // 初始化各个组件
                await initializeComponents();

                // 加载初始数据
                await loadOverviewStats();

            } catch (error) {
                console.error('初始化失败:', error);
                showError('系统初始化失败: ' + error.message);
            }
        }

        // 初始化组件
        async function initializeComponents() {
            // 创建上传组件
            ragUI.createUploader(
                document.getElementById('upload-container'),
                {
                    onSuccess: function(result) {
                        console.log('上传成功:', result);
                        loadOverviewStats(); // 刷新统计
                        showSuccess('文档上传成功！');
                    }
                }
            );

            // 创建搜索组件
            ragUI.createSearch(
                document.getElementById('search-container'),
                {
                    onResults: function(results) {
                        console.log('搜索结果:', results);
                    }
                }
            );

            // 创建文档管理组件
            ragUI.createDocumentManager(
                document.getElementById('documents-container'),
                {
                    onDocumentUpdate: function() {
                        loadOverviewStats(); // 刷新统计
                    }
                }
            );

            // 创建状态监控组件
            createStatusMonitor();
        }

        // 创建状态监控组件
        function createStatusMonitor() {
            const statusContainer = document.getElementById('status-container');
            
            statusContainer.innerHTML = `
                <div class="rag-card">
                    <h3>实时状态监控</h3>
                    <div id="status-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                        <div class="rag-stat-item" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                            <div class="rag-stat-value" id="db-status">检查中...</div>
                            <div class="rag-stat-label">数据库状态</div>
                        </div>
                        <div class="rag-stat-item" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border-radius: 10px;">
                            <div class="rag-stat-value" id="sync-status">检查中...</div>
                            <div class="rag-stat-label">同步状态</div>
                        </div>
                        <div class="rag-stat-item" style="text-align: center; padding: 20px; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border-radius: 10px;">
                            <div class="rag-stat-value" id="queue-status">检查中...</div>
                            <div class="rag-stat-label">队列状态</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="rag-btn rag-btn-primary" onclick="refreshStatus()">
                            <i class="fas fa-sync-alt"></i> 刷新状态
                        </button>
                        <button class="rag-btn rag-btn-success" onclick="manualSync()">
                            <i class="fas fa-sync"></i> 手动同步
                        </button>
                    </div>
                </div>
            `;

            // 初始加载状态
            refreshStatus();
        }

        // 加载概览统计
        async function loadOverviewStats() {
            try {
                const response = await fetch(`${RAG_CONFIG.apiBase}/stats`, {
                    headers: {
                        'Authorization': `Bearer ${RAG_CONFIG.token}`
                    }
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    displayOverviewStats(result.stats);
                } else {
                    throw new Error(result.message || '加载失败');
                }
            } catch (error) {
                console.error('加载统计失败:', error);
                showError('加载统计信息失败: ' + error.message);
            }
        }

        // 显示概览统计
        function displayOverviewStats(stats) {
            const statsContainer = document.getElementById('overview-stats');
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalDocuments || 0}</div>
                    <div class="stat-label">总文档数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalSize || 0} KB</div>
                    <div class="stat-label">总存储大小</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.avgRelevance || 0}%</div>
                    <div class="stat-label">平均相关度</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.lastUpdate || '未知'}</div>
                    <div class="stat-label">最后更新</div>
                </div>
            `;
        }

        // 刷新状态
        async function refreshStatus() {
            try {
                const response = await fetch(`${RAG_CONFIG.apiBase}/sync-status`, {
                    headers: {
                        'Authorization': `Bearer ${RAG_CONFIG.token}`
                    }
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    updateStatusDisplay(result);
                } else {
                    throw new Error(result.message || '加载失败');
                }
            } catch (error) {
                console.error('刷新状态失败:', error);
                showError('刷新状态失败: ' + error.message);
            }
        }

        // 更新状态显示
        function updateStatusDisplay(data) {
            const dbStatus = document.getElementById('db-status');
            const syncStatus = document.getElementById('sync-status');
            const queueStatus = document.getElementById('queue-status');

            // 数据库状态
            const dbHealthy = data.database.status === 'healthy';
            dbStatus.textContent = dbHealthy ? '健康' : '异常';
            dbStatus.style.color = dbHealthy ? '#27ae60' : '#e74c3c';

            // 同步状态
            const syncRunning = data.sync.isRunning;
            syncStatus.textContent = syncRunning ? '运行中' : '已停止';
            syncStatus.style.color = syncRunning ? '#27ae60' : '#f39c12';

            // 队列状态
            const queueSize = data.queue.queueSize;
            queueStatus.textContent = queueSize === 0 ? '空闲' : `${queueSize} 个待处理`;
            queueStatus.style.color = queueSize === 0 ? '#27ae60' : '#f39c12';
        }

        // 手动同步
        async function manualSync() {
            try {
                const response = await fetch(`${RAG_CONFIG.apiBase}/manual-sync`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${RAG_CONFIG.token}`
                    }
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    showSuccess('手动同步已触发');
                    setTimeout(refreshStatus, 2000); // 2秒后刷新状态
                } else {
                    throw new Error(result.message || '同步失败');
                }
            } catch (error) {
                console.error('手动同步失败:', error);
                showError('手动同步失败: ' + error.message);
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'rag-alert rag-alert-success';
            alert.textContent = message;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10000;
                padding: 15px 30px;
                border-radius: 8px;
                background: rgba(39, 174, 96, 0.1);
                border: 1px solid #27ae60;
                color: #27ae60;
                font-weight: 500;
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        // 显示错误消息
        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'rag-alert rag-alert-error';
            alert.textContent = message;
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10000;
                padding: 15px 30px;
                border-radius: 8px;
                background: rgba(231, 76, 60, 0.1);
                border: 1px solid #e74c3c;
                color: #e74c3c;
                font-weight: 500;
            `;
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // 退出登录
        function logout() {
            localStorage.removeItem('rag_token');
            window.location.href = '/public/login.html';
        }

        // 定期刷新状态
        setInterval(refreshStatus, 30000); // 每30秒刷新一次
    </script>
</body>
</html> 