name: Deploy to CloudBase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        
    - name: Install dependencies
      run: |
        cd server
        npm install
        
    - name: Install CloudBase CLI
      run: npm install -g @cloudbase/cli
      
    - name: Deploy to CloudBase
      env:
        TCB_SECRETID: ${{ secrets.TCB_SECRETID }}
        TCB_SECRETKEY: ${{ secrets.TCB_SECRETKEY }}
        TCB_ENVID: ${{ secrets.TCB_ENVID }}
      run: |
        # 登录腾讯云
        tcb login --apiKeyId $TCB_SECRETID --apiKey $TCB_SECRETKEY
        
        # 部署云函数
        tcb fn deploy api
        
        # 部署前端
        tcb hosting:deploy ./public -e $TCB_ENVID
        
        # 创建HTTP服务（如果需要）
        tcb service:create -e $TCB_ENVID -p /api -f api || true
        
    - name: Notify deployment
      run: |
        echo "🚀 部署完成！"
        echo "前端地址: https://${{ secrets.TCB_ENVID }}.tcloudbaseapp.com/"
        echo "API地址: https://${{ secrets.TCB_ENVID }}-1256790827.ap-shanghai.app.tcloudbase.com/api" 