name: Deploy to CloudBase

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        
    - name: Install dependencies
      run: |
        cd server
        npm install
        
    - name: Install CloudBase CLI
      run: npm install -g @cloudbase/cli
      
    - name: Deploy to CloudBase
      env:
        TCB_SECRETID: ${{ secrets.TCB_SECRETID }}
        TCB_SECRETKEY: ${{ secrets.TCB_SECRETKEY }}
        TCB_ENVID: ${{ secrets.TCB_ENVID }}
      run: |
        # ç™»å½•è…¾è®¯äº‘
        tcb login --apiKeyId $TCB_SECRETID --apiKey $TCB_SECRETKEY
        
        # éƒ¨ç½²äº‘å‡½æ•°
        tcb fn deploy api
        
        # éƒ¨ç½²å‰ç«¯
        tcb hosting:deploy ./public -e $TCB_ENVID
        
        # åˆ›å»ºHTTPæœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰
        tcb service:create -e $TCB_ENVID -p /api -f api || true
        
    - name: Notify deployment
      run: |
        echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
        echo "å‰ç«¯åœ°å€: https://${{ secrets.TCB_ENVID }}.tcloudbaseapp.com/"
        echo "APIåœ°å€: https://${{ secrets.TCB_ENVID }}-1256790827.ap-shanghai.app.tcloudbase.com/api" 