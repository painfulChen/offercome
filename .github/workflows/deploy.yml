name: Deploy and Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Deploy to CloudBase
      env:
        TCB_ENV: ${{ secrets.TCB_ENV }}
      run: |
        npm install -g @cloudbase/cli
        tcb login --apiKeyId ${{ secrets.TENCENT_SECRET_ID }} --apiKey ${{ secrets.TENCENT_SECRET_KEY }}
        tcb framework deploy
    
    - name: Smoke test MBTI API
      run: |
        BASE="https://${{ secrets.TCB_ENV }}-1256790827.ap-shanghai.app.tcloudbase.com/api-v2"
        
        echo "🧪 开始API烟雾测试..."
        
        # 测试健康检查
        echo "📋 测试健康检查..."
        curl -sf "$BASE/health" | jq '.status=="ok"'
        
        # 测试MBTI问题获取
        echo "📋 测试MBTI问题获取..."
        curl -sf "$BASE/mbti/questions" | jq '.data | length==32'
        
        # 测试MBTI计算
        echo "📋 测试MBTI计算..."
        curl -sf -X POST "$BASE/mbti/calculate" \
             -H 'Content-Type: application/json' \
             -d '{"answers":[0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1]}' \
          | jq '.data.mbtiType | length==4'
        
        # 测试MBTI职业建议
        echo "📋 测试MBTI职业建议..."
        curl -sf "$BASE/mbti/career-advice" | jq '.data | length>0'
        
        echo "✅ 所有API测试通过！" 